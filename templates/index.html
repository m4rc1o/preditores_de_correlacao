<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">


    <title>Preditores de correlação</title>
</head>
<body>
    <h1>Preditor BHT</h1>
    <div id="div-main">
        <table id="tabela-desvios">
            <caption> <strong>DESVIOS</strong></caption>
            <tr><th>endereço</th><th>direção</th></tr>
            {% for desvio in desvios %}
                <tr id={{"desv-" + desvio[0]}} name="linha-desvios"><td>{{ desvio[0] }}</td><td>{{ desvio[1] }}</td></tr>
            {%endfor%}
        </table>
        <table id="tabela-bht">
            <caption> <strong>BHT</strong></caption>
            <tr><th>endereço</th><th>histórico</th></tr>
            {% for end, hist in BHT.items() %}
                <tr id={{"BHT-" + end}} name="linha-BHT"><td>{{ end }}</td><td>{{ hist }}</td></tr>
            {%endfor%}
        </table>
        <table id="tabela-pht">
            <caption> <strong>PADRÃO DOS DESVIOS</strong></caption>
            <tr><th>endereço</th><th id="th-contadores" colspan="qtdContadores()">contadores</th></tr>
            {% for end, list_valores in contadores2.items() %}
                <tr id={{"PHT-" + end}} name="linha-PHT">
                    <td>{{ end }}</td>
                    {% for valCont in list_valores %}
                    <td name={{"contadores-" + end}} class="contadores">{{ valCont }}</td>
                    {% endfor %}
                </tr>
            {% endfor %}
        </table>
    </div>
    
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"
        integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.js"></script>
   
   <script type="text/javascript" charset="UTF-8">
        /*Seta o colspan do título "contadores"*/
        var contadores = {{contadores2|tojson|safe}}
        $("#th-contadores").attr('colspan', contadores[Object.keys(contadores)[1]].length)
        
        var linhasDesvios = $('tr[name="linha-desvios"')
        var linhasBHT = $('tr[name="linha-BHT"')
        var linhaBHT_anterior, linhaBHT_atual
        var lnhasPHT = $('td[name="linha-PHT"')
        var linhaPHT_anterior, linhaPHt_atual, tdContadorAnterior, tdContadorAtual
        
        var i = 0
        function loop(){
            setTimeout(function(){
                var tdEnderecoDesvio = $(linhasDesvios[i]).children('td')[0]
                var tdDirecaoRealizada = $(linhasDesvios[i]).children('td')[1]

                $(tdEnderecoDesvio).css({'background-color': 'red'})
    
                linhaBHT_atual = $("#BHT-" + tdEnderecoDesvio.innerHTML)
                linhaBHT_atual.css({'background-color': 'red'})
                atualizarBHT(tdEnderecoDesvio.innerHTML, tdDirecaoRealizada.innerHTML)

                linhaPHt_atual = $("#PHT-" + tdEnderecoDesvio.innerHTML)
                linhaPHt_atual.css({'background-color': 'gray'})
                histDesviosAtual = $(linhaBHT_atual).children('td')[1].innerHTML
                tdContadorAtual = atulizarContador(tdEnderecoDesvio.innerHTML, histDesviosAtual, tdDirecaoRealizada.innerHTML)

                if(i > 0){
                    tdEndDesvioAnterior = $(linhasDesvios[i - 1]).children('td')[0]
                    $(tdEndDesvioAnterior).css({'background-color': 'white'})
                    $(tdContadorAnterior).css({'background-color': 'white'})
                    
                    if(linhaBHT_atual.attr('id') !== linhaBHT_anterior.attr('id')){
                        linhaBHT_anterior.css({'background-color': 'white'})
                        linhaPHT_anterior.css({'background-color': 'white'})
                    }
                }

                linhaBHT_anterior = linhaBHT_atual
                linhaPHT_anterior = linhaPHt_atual
                tdContadorAnterior = tdContadorAtual
                ++i
                if(i < linhasDesvios.length){
                    loop()
                }
            }, 500)
        }
        loop()
    
        function atualizarBHT(enderDesvio, dirRealizada){
            var trLinhaBHT = $("#BHT-" + enderDesvio)
            var tdHistoricoDesvios = $(trLinhaBHT).children('td')[1]
            var listaHistoricoDesvios = JSON.parse(tdHistoricoDesvios.innerHTML)
            if(dirRealizada == 't')
                listaHistoricoDesvios.unshift(1)
            else
                listaHistoricoDesvios.unshift(0)
            listaHistoricoDesvios.pop()
            $(tdHistoricoDesvios).html('[' + listaHistoricoDesvios.toString() + ']')
        }

        function atulizarContador(enderDesvio, histDesvio, dirRealizada){
            tdContador = $('td[name="contadores-' + enderDesvio)[historicoToIndice(histDesvio)]
            var valorContador = parseInt(tdContador.innerHTML)
            if(dirRealizada == 't'){
                if(valorContador < 3){
                    valorContador +=1
                    $(tdContador).css({'background-color': 'green'})
                }
            }else{
                if(valorContador > 0){
                    valorContador -=1
                    $(tdContador).css({'background-color': 'red'})                    
                }
            }
            $(tdContador).html(valorContador)
            return tdContador
        }
        

        function historicoToIndice(strHist){
            /*Converte uma string na forma "[b1, b2, ..., bn]"(Histórico de desvios), 
            onde bi pertence a {0, 1} para um inteiro entre 0 e 2^n - 1*/
            var strHistBits = strHist.replace(/\[|\]|,/g, '')
            var numDecimal = parseInt(strHistBits, 2)
            return numDecimal
        }
    </script>

    <style>
        h1{
            text-align: center;
        }
        
        table{
            text-align: center;
            border: 2px solid green;
        }

        td{
            padding: 0px 10px 0px 10px;
        }

        #div-main{
            width: 100%;
            display: flex;
            justify-content: space-evenly;
            padding-top: 50px;
        }

        .contadores{
            padding: 0px 5px 0px 5px;
        }

        
    </style>
</body>
</html>